# Create autoload and link standard tools if not already
nop %sh{
   mkdir -p "$kak_config/autoload"
   ln -sfn "$kak_runtime/autoload" "$kak_config/autoload/standard-library"
}

# UI configuration
# ────────────────
set-option global startup_info_version 20200901464                            # Hide change notes on startup
set-option global tabstop 3                                                   # Width of a tab
set-option global indentwidth 3                                               # Indent with 3 spaces
set-option global scrolloff 99,99                                             # Center cursor
set-option global ui_options ncurses_assistant=off ncurses_status_on_top=true # Disable clippy
set-option global autoreload yes                                              # Live reload
set-option global writemethod replace                                         # Live reload method
set-option global modelinefmt '{{mode_info}} {magenta}%val{bufname}{default} {green}%val{client}{default}/{yellow}%val{session}{default} {{context_info}}'

# Blank scratch buffer
hook -group delete-scratch-message global BufCreate '\Q*scratch*' %{
   execute-keys '%d'
}

# Color TODO, NOTE, etc. separately
hook global WinSetOption comment_line=(.*) %{
    add-highlighter -override window/todo regex "\Q%val{hook_param_capture_1}\E\h*(TODO:|FIXME:|NOTE:|XXX:)[^\n]*" 1:rgb:21c0d5+Fb
}

# Make search results bold
hook global RegisterModified '/' %{ add-highlighter -override global/search regex "%reg{/}" 0:+b }

# Global highlighters
#add-highlighter global/ wrap -word -indent -marker ↳
#add-highlighter global/ regex \h+$ 0:Error	# Highlight trailing whitespace

# Line numbers
hook global WinCreate (?!/tmp/[.]nnn)[^*]+ %{
   add-highlighter window/relative-line-numbers number-lines -relative -separator '  '
}

# Highlight matching brackets
hook global WinCreate .* %{
	add-highlighter window/ show-matching
}

# Theme
# ─────
colorscheme lena

# Change selection colors in insert mode
hook global ModeChange .*:.*:insert %{
   set-face window PrimarySelection black,rgb:bfbfbf+F
   set-face window SecondarySelection black,rgb:bfbfbf+u
   set-face window PrimaryCursor black,rgb:E4E4DF+b
   set-face window SecondaryCursor black,rgb:E4E4DF+u
   set-face window PrimaryCursorEol black,rgb:E4E4DF+b
   set-face window SecondaryCursorEol black,rgb:E4E4DF+u
}

# Revert cursor colors after reentering normal mode
hook global ModeChange .*:insert:.* %{
   unset-face window PrimarySelection
   unset-face window SecondarySelection
   unset-face window PrimaryCursor
   unset-face window SecondaryCursor
   unset-face window PrimaryCursorEol
   unset-face window SecondaryCursorEol
}

# Functionality
# ─────────────

# Save after lost focus
hook global FocusOut .* %{
   write-all
} -group kakrc-save-on-lost-focus

# Cycle autocompletions with Tab
hook global InsertCompletionShow .* %{
   try %{
      exec -draft 'h<a-K>\h<ret>'
      map window insert <s-tab> <c-p>
      map window insert <tab> <c-n>
   }
}

hook global InsertCompletionHide .* %{
   unmap window insert <tab> <c-n>
   unmap window insert <s-tab> <c-p>
}

# Commands
# ────────
define-command clean-whitespace %{ execute-keys -draft '<percent>s^<space><plus>$<ret>d' }

# https://github.com/alexherbo2/configuration/blob/2d5bdd7264232819df01c92b4810d5aa0d4f9d5e/config/kak/autoload/chmod.kak#L5-L9
define-command chmod -params .. -docstring 'Change access permissions of the current file' %{
   nop %sh{
      chmod "$@" "$kak_buffile"
   }
}

source "%val{config}/scripts/sync.kak"
